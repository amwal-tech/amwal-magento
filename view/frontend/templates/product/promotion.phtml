<?php
use Magento\Catalog\Block\Product\ProductList\Item\Block;
use Magento\Framework\Escaper;
use Magento\Framework\View\Element\Template;
/**
 * @var Escaper $escaper
 * @var Template|Block $block
 */
?>

<?php if ($block->isPromotionsActive()): ?>
    <script>
        (function() {
            // Check if we have required dependencies
            if (typeof require === 'undefined') {
                console.warn('Amwal Promotion: RequireJS not available');
                return;
            }

            const amwalConfig = {
                installmentsCount: <?= (int) $block->getInstallmentsCount() ?>,
                price: <?= (float) $block->getPrice() ?>,
            };

            /**
             * Update the Amwal promotion based on the given price and currency.
             * Calculates the installment price and updates elements and the iframe if it exists.
             * @param {number} price - The new product price.
             * @param {string} currency - The product's currency.
             */
            const updateAmwalPromotions = (price, currency) => {
                try {
                    if (!price || !currency || isNaN(price) || price <= 0) {
                        document.getElementById('amwal-promo').style.display = 'none';
                        return;
                    }

                    const installmentPrice = price / amwalConfig.installmentsCount;

                    // Update config for when iframe is created
                    amwalConfig.price = price;

                    // Update text for installment count and price
                    document.querySelectorAll('.amwal-installments-count').forEach(el => {
                        el.innerText = amwalConfig.installmentsCount;
                    });
                    document.querySelectorAll('.amwal-price').forEach(el => {
                        el.innerText = `${currency} ${installmentPrice.toFixed(2)}`;
                    });

                    // Show promotion if hidden
                    const promoElement = document.getElementById('amwal-promo');
                    if (promoElement) {
                        promoElement.style.display = 'flex';
                    }

                    // Update the iframe's query parameters only if it exists (modal is open)
                    const amwalIframe = document.getElementById('amwal-iframe');
                    if (amwalIframe && amwalIframe.src) {
                        try {
                            const [baseUrl, queryString] = amwalIframe.src.split('?');
                            const params = new URLSearchParams(queryString || '');
                            params.set('price', installmentPrice.toFixed(2));
                            params.set('currency', currency);
                            params.set('installmentsCount', amwalConfig.installmentsCount);
                            params.set('locale', document.documentElement.lang || 'en');
                            amwalIframe.src = `${baseUrl}?${params.toString()}`;
                        } catch (e) {
                            console.warn('Amwal Promotion: Error updating iframe URL', e);
                        }
                    }
                } catch (error) {
                    console.error('Amwal Promotion: Error updating promotions', error);
                }
            };

            /**
             * Extracts price data from the given element and updates promotions.
             * @param {HTMLElement} elem - The element containing price data.
             */
            const handlePriceUpdate = (elem) => {
                try {
                    if (!elem) {
                        return;
                    }

                    const priceElement = elem.querySelector('[data-price-type="finalPrice"]');
                    const priceAttr = priceElement?.getAttribute('data-price-amount');

                    if (!priceAttr) {
                        document.getElementById('amwal-promo').style.display = 'none';
                        return;
                    }

                    const price = parseFloat(priceAttr);
                    const currencyElement = document.querySelector('meta[itemprop="priceCurrency"]');
                    const currency = currencyElement?.getAttribute('content') || 'USD';

                    if (!isNaN(price) && price > 0 && currency) {
                        updateAmwalPromotions(price, currency);
                    } else {
                        document.getElementById('amwal-promo').style.display = 'none';
                    }
                } catch (error) {
                    console.error('Amwal Promotion: Error handling price update', error);
                }
            };

            /**
             * Creates the iframe dynamically with current promotion data
             */
            const createAmwalIframe = () => {
                try {
                    const iframe = document.createElement('iframe');
                    iframe.id = 'amwal-iframe';
                    iframe.frameBorder = '0';
                    iframe.loading = 'lazy';
                    iframe.allowFullscreen = true;
                    iframe.sandbox = 'allow-scripts allow-same-origin allow-forms';

                    // Get the base URL from the PHP block
                    const baseUrl = '<?php echo htmlspecialchars($block->getPromotionUrl(), ENT_QUOTES, 'UTF-8'); ?>';

                    // Create URL with current parameters
                    const params = new URLSearchParams();
                    const currentPrice = amwalConfig.price / amwalConfig.installmentsCount;
                    const currencyElement = document.querySelector('meta[itemprop="priceCurrency"]');
                    const currency = currencyElement?.getAttribute('content') || 'USD';

                    params.set('price', currentPrice.toFixed(2));
                    params.set('currency', currency);
                    params.set('installmentsCount', amwalConfig.installmentsCount);
                    params.set('locale', document.documentElement.lang || 'en');

                    iframe.src = `${baseUrl}?${params.toString()}`;

                    // Apply minimal inline styles for maximum protection
                    iframe.style.cssText = `
                    width: 100% !important;
                    height: 700px !important;
                    border: none !important;
                    display: block !important;
                `.replace(/\s+/g, ' ');

                    return iframe;
                } catch (error) {
                    console.error('Amwal Promotion: Error creating iframe', error);
                    return null;
                }
            };

            /**
             * Creates and manages the modal overlay with history support
             */
            const createModalOverlay = () => {
                try {
                    // Remove existing overlay if present
                    const existingOverlay = document.getElementById('amwal-modal-overlay');
                    if (existingOverlay) {
                        closeModalOverlay();
                    }

                    // Add a simple history entry so back button works
                    if (window.history && window.history.pushState) {
                        window.history.pushState({ amwalModal: true }, '');
                    }

                    // Create new overlay with specific attributes to avoid conflicts
                    const overlay = document.createElement('div');
                    overlay.id = 'amwal-modal-overlay';
                    overlay.className = 'amwal-modal-overlay';
                    overlay.setAttribute('data-amwal-modal', 'true');
                    overlay.style.cssText = `
                    position: fixed !important;
                    top: 0 !important;
                    left: 0 !important;
                    width: 100vw !important;
                    height: 100vh !important;
                    background: rgba(0, 0, 0, 0.75) !important;
                    display: flex !important;
                    align-items: center !important;
                    justify-content: center !important;
                    z-index: 999999 !important;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
                `.replace(/\s+/g, ' ');

                    // Create modal container from template
                    const modalTemplate = document.getElementById('amwal-dialog');
                    if (!modalTemplate) {
                        console.error('Amwal Promotion: Modal template not found');
                        return null;
                    }

                    const modalContainer = modalTemplate.cloneNode(true);
                    modalContainer.style.display = 'block';
                    modalContainer.className = 'amwal-modal-container';
                    modalContainer.setAttribute('data-amwal-content', 'true');

                    // Apply inline styles to override any conflicting CSS
                    modalContainer.style.cssText = `
                    width: 90vw !important;
                    max-width: 833px !important;
                    max-height: 95vh !important;
                    margin: 0 !important;
                    padding: 0 !important;
                    border: none !important;
                    background: linear-gradient(to bottom, #e8f4ef, #f5faf7) !important;
                    border-radius: 17px !important;
                    color: #292929 !important;
                    overflow: hidden !important;
                    display: flex !important;
                    flex-direction: column !important;
                    position: relative !important;
                    text-align: left !important;
                `.replace(/\s+/g, ' ');

                    // Create and insert the iframe dynamically
                    const amwalBody = modalContainer.querySelector('.amwal-body');
                    if (amwalBody) {
                        // Clear any existing content
                        amwalBody.innerHTML = '';

                        // Create iframe directly
                        const iframe = createAmwalIframe();
                        if (iframe) {
                            amwalBody.appendChild(iframe);
                        } else {
                            console.error('Amwal Promotion: Failed to create iframe');
                            return null;
                        }
                    }

                    overlay.appendChild(modalContainer);
                    document.body.appendChild(overlay);

                    // Prevent body scroll
                    document.body.style.overflow = 'hidden';

                    return overlay;
                } catch (error) {
                    console.error('Amwal Promotion: Error creating modal overlay', error);
                    return null;
                }
            };

            /**
             * Closes the modal overlay
             */
            const closeModalOverlay = () => {
                try {
                    const overlay = document.getElementById('amwal-modal-overlay');
                    if (overlay) {
                        overlay.remove();
                        document.body.style.overflow = '';
                    }
                } catch (error) {
                    console.error('Amwal Promotion: Error closing modal overlay', error);
                }
            };

            // Handle browser back button to close modal
            window.addEventListener('popstate', function(event) {
                const overlay = document.getElementById('amwal-modal-overlay');
                if (overlay) {
                    // Modal is open and user pressed back - close it
                    closeModalOverlay();
                }
            });

            // Handle ESC key to close modal
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape' || event.keyCode === 27) {
                    const overlay = document.getElementById('amwal-modal-overlay');
                    if (overlay) {
                        // Close modal and go back in history
                        closeModalOverlay();
                        if (window.history && window.history.back) {
                            window.history.back();
                        }
                    }
                }
            });

            // Initialize when DOM is ready
            require(['jquery'], function ($) {
                try {
                    // Bind events for standard products using a combined event string
                    $('.product-info-main .product-info-price .price-box.price-final_price')
                        .on('reloadPrice price-box-initialized', function() {
                            handlePriceUpdate(this);
                        });

                    // For grouped products, recalculate the total price based on quantities
                    const $groupTable = $('#super-product-table');
                    if ($groupTable.length) {
                        const updateGroupedProducts = () => {
                            try {
                                let totalPrice = 0;
                                const currencyElement = $('meta[itemprop="priceCurrency"]');
                                const currency = currencyElement.attr('content') || 'USD';
                                let valid = true;

                                $groupTable.find('.price-box.price-final_price').each(function() {
                                    const $priceBox = $(this);
                                    const priceElement = $priceBox.find('[data-price-type="finalPrice"]');
                                    const localPrice = parseFloat(priceElement.attr('data-price-amount'));
                                    const localId = $priceBox.data('product-id');
                                    const qtyElement = $groupTable.find(`[data-selector="super_group[${localId}]"]`);
                                    const localQty = parseFloat(qtyElement.val()) || 0;
                                    const subtotal = localPrice * localQty;

                                    if (!isNaN(subtotal) && subtotal >= 0) {
                                        totalPrice += subtotal;
                                    } else {
                                        valid = false;
                                    }
                                });

                                if (valid && totalPrice > 0) {
                                    updateAmwalPromotions(totalPrice, currency);
                                } else {
                                    document.getElementById('amwal-promo').style.display = 'none';
                                }
                            } catch (error) {
                                console.error('Amwal Promotion: Error updating grouped products', error);
                            }
                        };

                        // Bind change events and initialize grouped products update
                        $groupTable.find('[data-selector^="super_group"]').on('change', updateGroupedProducts);
                        updateGroupedProducts();
                    }

                    // Handle modal opening with custom overlay
                    $('#amwal-promo').on('click', function (e) {
                        e.preventDefault();
                        try {
                            const overlay = createModalOverlay();
                            if (!overlay) {
                                return;
                            }

                            // Close modal on overlay click
                            overlay.addEventListener('click', function(e) {
                                if (e.target === overlay) {
                                    closeModalOverlay();
                                    if (window.history && window.history.back) {
                                        window.history.back();
                                    }
                                }
                            });

                            // Close modal on close button click
                            const closeButton = overlay.querySelector('.amwal-close');
                            if (closeButton) {
                                closeButton.addEventListener('click', function() {
                                    closeModalOverlay();
                                    if (window.history && window.history.back) {
                                        window.history.back();
                                    }
                                });
                            }
                        } catch (error) {
                            console.error('Amwal Promotion: Error handling modal click', error);
                        }
                    });

                    // Initial price update
                    const initialPriceBox = $('.product-info-main .product-info-price .price-box.price-final_price').first();
                    if (initialPriceBox.length) {
                        handlePriceUpdate(initialPriceBox[0]);
                    }

                } catch (error) {
                    console.error('Amwal Promotion: Error initializing jQuery functionality', error);
                }
            });

            // Cart page integration
            if (window.location.href.indexOf('checkout/cart') !== -1) {
                require(['Magento_Checkout/js/model/quote'], function (quote) {
                    try {
                        function updateAmwalTotal(totals) {
                            if (totals && totals.grand_total) {
                                let price = parseFloat(totals.grand_total);
                                if (totals.tax_amount) {
                                    price += parseFloat(totals.tax_amount);
                                }
                                updateAmwalPromotions(price, totals.quote_currency_code || 'USD');
                            }
                        }

                        const quoteTotals = quote.getTotals();
                        if (quoteTotals && quoteTotals.subscribe) {
                            quoteTotals.subscribe(updateAmwalTotal);
                        }

                        const currentTotals = quote.totals();
                        if (currentTotals) {
                            updateAmwalTotal(currentTotals);
                        }
                    } catch (error) {
                        console.error('Amwal Promotion: Error in cart integration', error);
                    }
                });
            }
        })();
    </script>

    <!-- Keep all the existing CSS styles -->
    <style>
        /* CSS Reset for Amwal Components */
        .amwal-reset,
        .amwal-reset *,
        .amwal-reset *::before,
        .amwal-reset *::after {
            margin: 0 !important;
            padding: 0 !important;
            border: 0 !important;
            font-size: 100% !important;
            font: inherit !important;
            vertical-align: baseline !important;
            box-sizing: border-box !important;
            background: transparent !important;
            text-decoration: none !important;
            list-style: none !important;
            outline: none !important;
            -webkit-tap-highlight-color: transparent !important;
        }

        /* Amwal Promo Button - Isolated Styles */
        #amwal-promo {
            all: initial !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
            cursor: pointer !important;
            box-sizing: border-box !important;
            position: relative !important;
            padding: 12px 15px !important;
            border-radius: 8px !important;
            border: 1px solid #000 !important;
            color: #222 !important;
            background: #fff !important;
            width: 100% !important;
            max-width: 495px !important;
            margin: 10px 0 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: space-between !important;
            z-index: 1000 !important;
            transition: all 0.2s ease !important;
        }

        #amwal-promo:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
            transform: translateY(-1px) !important;
        }

        #amwal-promo.green-border {
            border-top: 3px solid #4CAF50 !important;
        }

        .amwal-logo {
            position: static !important;
            width: 65px !important;
            height: auto !important;
            margin-right: 12px !important;
            flex-shrink: 0 !important;
        }

        .amwal-promo-content {
            display: flex !important;
            align-items: center !important;
            flex-grow: 1 !important;
            font-family: inherit !important;
        }

        .amwal-promo-text {
            font-weight: 500 !important;
            font-size: 14px !important;
            line-height: 1.4 !important;
            color: #222 !important;
            font-family: inherit !important;
        }

        .amwal-link {
            color: #4666f5 !important;
            text-decoration: underline !important;
            font-size: 14px !important;
            white-space: nowrap !important;
            font-family: inherit !important;
        }

        /* RTL Support */
        :lang(ar) #amwal-promo {
            direction: rtl !important;
        }

        :lang(ar) .amwal-logo {
            margin-right: 0 !important;
            margin-left: 20px !important;
            width: 75px !important;
        }

        :lang(ar) .amwal-promo-text {
            font-size: 18px !important;
        }

        /* Modal Overlay - Completely Isolated */
        .amwal-modal-overlay {
            all: initial !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            background: rgba(0, 0, 0, 0.75) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            z-index: 999999 !important;
            backdrop-filter: blur(4px) !important;
            animation: amwal-fade-in 0.3s ease !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
        }

        /* CSS Specificity Boosters - Use attribute selectors to increase specificity */
        div[data-amwal-modal="true"].amwal-modal-overlay {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 999999 !important;
            background: rgba(0, 0, 0, 0.75) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        div[data-amwal-content="true"].amwal-modal-container {
            width: 90vw !important;
            max-width: 900px !important;
            max-height: 95vh !important;
            margin: 0 !important;
            padding: 0 !important;
            border: none !important;
            background: linear-gradient(to bottom, #e8f4ef, #f5faf7) !important;
            border-radius: 17px !important;
            color: #292929 !important;
            text-align: left !important;
            overflow: hidden !important;
            display: flex !important;
            flex-direction: column !important;
            position: relative !important;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3) !important;
        }

        /* Ultimate fallback with maximum specificity */
        html body div[data-amwal-modal="true"].amwal-modal-overlay {
            all: unset !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            background: rgba(0, 0, 0, 0.75) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            z-index: 999999 !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
        }

        html body div[data-amwal-modal="true"].amwal-modal-overlay div[data-amwal-content="true"].amwal-modal-container {
            all: unset !important;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
            width: 90vw !important;
            max-width: 900px !important;
            max-height: 95vh !important;
            background: linear-gradient(to bottom, #e8f4ef, #f5faf7) !important;
            border-radius: 17px !important;
            color: #292929 !important;
            overflow: hidden !important;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3) !important;
            display: flex !important;
            flex-direction: column !important;
            text-align: left !important;
            margin: 0 !important;
            padding: 0 !important;
            border: none !important;
            position: relative !important;
        }

        @keyframes amwal-fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Modal Container - Override any conflicting modal styles */
        .amwal-modal-overlay .amwal-modal-container,
        div.amwal-modal-overlay div.amwal-modal-container {
            all: initial !important;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
            width: 90vw !important;
            max-width: 800px !important;
            max-height: 90vh !important;
            min-width: unset !important;
            min-height: unset !important;
            margin: 0 !important;
            padding: 0 !important;
            border: none !important;
            background: linear-gradient(to bottom, #e8f4ef, #f5faf7) !important;
            border-radius: 17px !important;
            color: #292929 !important;
            overflow: hidden !important;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3) !important;
            display: flex !important;
            flex-direction: column !important;
            animation: amwal-slide-up 0.3s ease !important;
            text-align: left !important;
            position: relative !important;
            top: unset !important;
            left: unset !important;
            right: unset !important;
            bottom: unset !important;
            transform: none !important;
        }

        @keyframes amwal-slide-up {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Modal Header */
        .amwal-modal-container .amwal-header {
            all: initial !important;
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            padding: 16px 20px 8px 20px !important;
            background: inherit !important;
            font-family: inherit !important;
            flex-shrink: 0 !important;
        }

        .amwal-modal-container .amwal-header > svg {
            width: 80px !important;
            height: 32px !important;
        }

        .amwal-modal-container .amwal-close {
            all: initial !important;
            position: relative !important;
            cursor: pointer !important;
            width: 24px !important;
            height: 24px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            border-radius: 50% !important;
            transition: background-color 0.2s ease !important;
            padding: 4px !important;
        }

        .amwal-modal-container .amwal-close:hover {
            background-color: rgba(0,0,0,0.1) !important;
        }

        .amwal-modal-container .amwal-close:before,
        .amwal-modal-container .amwal-close:after {
            content: '' !important;
            position: absolute !important;
            top: 50% !important;
            left: 50% !important;
            width: 16px !important;
            height: 2px !important;
            background-color: #3e3e3e !important;
            border-radius: 1px !important;
            transform-origin: center !important;
        }

        .amwal-modal-container .amwal-close:before {
            transform: translate(-50%, -50%) rotate(45deg) !important;
        }

        .amwal-modal-container .amwal-close:after {
            transform: translate(-50%, -50%) rotate(-45deg) !important;
        }

        /* Modal Body */
        .amwal-modal-container .amwal-body {
            all: initial !important;
            flex: 1 !important;
            padding: 0 20px 20px 20px !important;
            overflow: hidden !important;
            display: flex !important;
            flex-direction: column !important;
        }

        /* Iframe - Dynamic Generation */
        #amwal-iframe {
            width: 100% !important;
            height: 700px !important;
            border: none !important;
            display: block !important;
        }

        /* Responsive Design with enhanced conflict protection */
        @media only screen and (max-width: 768px) {
            .amwal-modal-overlay .amwal-modal-container,
            div.amwal-modal-overlay div.amwal-modal-container {
                width: 95vw !important;
                max-height: 95vh !important;
                margin: 10px !important;
                text-align: left !important;
            }

            .amwal-modal-overlay .amwal-header,
            .amwal-modal-overlay .amwal-body,
            div.amwal-modal-overlay div.amwal-header,
            div.amwal-modal-overlay div.amwal-body {
                padding-left: 16px !important;
                padding-right: 16px !important;
                text-align: left !important;
            }

            .amwal-modal-overlay .amwal-header {
                padding-top: 12px !important;
                padding-bottom: 6px !important;
            }

            .amwal-modal-overlay .amwal-body {
                padding-bottom: 16px !important;
            }

            #amwal-iframe {
                height: 600px !important;
                width: 100% !important;
            }

            #amwal-promo,
            div#amwal-promo {
                max-width: 100% !important;
                padding: 10px 12px !important;
                width: 100% !important;
                margin: 10px 0 !important;
            }

            .amwal-promo-text {
                font-size: 13px !important;
            }
        }

        @media only screen and (max-width: 480px) {
            .amwal-modal-overlay .amwal-modal-container,
            div.amwal-modal-overlay div.amwal-modal-container {
                width: 100vw !important;
                height: 100vh !important;
                max-height: 100vh !important;
                border-radius: 0 !important;
                margin: 0 !important;
                text-align: left !important;
            }

            .amwal-modal-overlay .amwal-header {
                padding: 10px 16px 6px 16px !important;
            }

            .amwal-modal-overlay .amwal-body {
                padding: 0 16px 16px 16px !important;
            }

            #amwal-iframe {
                height: calc(100vh - 100px) !important;
                width: 100% !important;
            }
        }

        /* Comprehensive protection against theme modal CSS conflicts */
        .amwal-modal-overlay *[class*="modal"],
        .amwal-modal-overlay .modal,
        .amwal-modal-overlay .modal-dialog,
        .amwal-modal-overlay .modal-content,
        .amwal-modal-overlay .modal-header,
        .amwal-modal-overlay .modal-body,
        .amwal-modal-overlay .modal-footer,
        div.amwal-modal-overlay *[class*="modal"],
        div.amwal-modal-overlay .modal,
        div.amwal-modal-overlay .modal-dialog,
        div.amwal-modal-overlay .modal-content,
        div.amwal-modal-overlay .modal-header,
        div.amwal-modal-overlay .modal-body,
        div.amwal-modal-overlay .modal-footer {
            all: unset !important;
            box-sizing: border-box !important;
            display: block !important;
            position: static !important;
            width: auto !important;
            height: auto !important;
            margin: 0 !important;
            padding: 0 !important;
            border: none !important;
            background: transparent !important;
            color: inherit !important;
            font-family: inherit !important;
            font-size: inherit !important;
            font-weight: inherit !important;
            line-height: inherit !important;
            text-align: inherit !important;
            text-decoration: none !important;
            text-transform: none !important;
            letter-spacing: normal !important;
            word-spacing: normal !important;
            white-space: normal !important;
            vertical-align: baseline !important;
            list-style: none !important;
            outline: none !important;
            box-shadow: none !important;
            border-radius: 0 !important;
            opacity: 1 !important;
            visibility: visible !important;
            overflow: visible !important;
            z-index: auto !important;
            transform: none !important;
            transition: none !important;
            animation: none !important;
            float: none !important;
            clear: none !important;
        }

        /* Prevent theme interference */
        .amwal-modal-overlay,
        .amwal-modal-overlay *,
        #amwal-promo,
        #amwal-promo *,
        div.amwal-modal-overlay,
        div.amwal-modal-overlay *,
        div#amwal-promo,
        div#amwal-promo * {
            text-transform: none !important;
            letter-spacing: normal !important;
            word-spacing: normal !important;
            text-shadow: none !important;
            filter: none !important;
            opacity: 1 !important;
            visibility: visible !important;
            transform: none !important;
            animation-delay: 0s !important;
            animation-duration: 0.3s !important;
            animation-fill-mode: both !important;
            float: none !important;
            clear: none !important;
            position: relative !important;
        }

        /* Fix overlay positioning */
        .amwal-modal-overlay {
            position: fixed !important;
            z-index: 999999 !important;
        }

        .amwal-modal-overlay .amwal-modal-container {
            position: relative !important;
        }
    </style>

    <div id="amwal-promo" class="amwal-reset">
        <div class="amwal-promo-content">
            <svg width="72" height="29" viewBox="0 0 72 29" fill="none" xmlns="http://www.w3.org/2000/svg" class="amwal-logo">
                <rect width="72" height="28.946" rx="6" fill="black"/>
                <path d="M24.1912 11.6545C25.5297 10.5672 27.8358 10.9347 28.8503 12.3232C28.8972 12.3845 28.9818 12.3896 29.0287 12.3334C29.0804 12.2722 29.1274 12.2109 29.179 12.1547C29.7191 11.5626 30.3861 11.241 31.1328 11.0981C31.9219 10.9449 32.7015 10.9909 33.453 11.3125C34.3641 11.7004 34.9794 12.4253 35.3598 13.3901C35.6369 14.0843 35.7684 14.8194 35.7731 15.5698C35.7825 17.1216 35.7778 18.6785 35.7872 20.2303C35.7872 20.3579 35.7543 20.3783 35.6463 20.3783C34.9512 20.3732 34.2561 20.3732 33.5657 20.3783C33.453 20.3783 33.4201 20.3528 33.4201 20.2252C33.4248 18.7551 33.4248 17.2849 33.4248 15.8148C33.4248 15.386 33.359 14.9725 33.1712 14.5897C32.5747 13.3748 31.0859 13.2522 30.3109 14.36C30.015 14.7836 29.8741 15.2686 29.8741 15.7944C29.8741 17.2747 29.8741 18.7551 29.8788 20.2354C29.8788 20.3528 29.8506 20.3783 29.7473 20.3783C29.0381 20.3732 28.3242 20.3732 27.615 20.3783C27.5211 20.3783 27.4976 20.3528 27.4976 20.2507C27.5023 18.7704 27.4976 17.29 27.5023 15.8097C27.5023 15.534 27.4788 15.2584 27.4178 14.9878C27.244 14.263 26.6804 13.7168 25.9994 13.6147C24.9521 13.4564 24.3227 14.314 24.1161 15.0644C24.0409 15.3298 24.0127 15.6004 24.0127 15.8811C24.0127 17.29 24.0127 18.704 24.0174 20.1129C24.0174 20.2609 23.9094 20.3783 23.7732 20.3783C23.1016 20.3732 22.43 20.3732 21.7536 20.3783C21.655 20.3783 21.6362 20.3477 21.6362 20.2507C21.6409 17.2798 21.6409 14.314 21.6362 11.3431C21.6362 11.2512 21.6503 11.2206 21.7443 11.2206C22.4675 11.2257 23.1908 11.2257 23.9141 11.2206C23.9892 11.2206 24.0174 11.2359 24.0127 11.3227C24.008 11.4044 24.008 11.4809 24.008 11.5626C24.008 11.6596 24.1161 11.7157 24.1912 11.6545Z" fill="white"/>
                <path d="M43.8655 20.384C43.8233 20.4759 43.7012 20.4759 43.6589 20.384C43.3724 19.7357 43.0906 19.0976 42.8088 18.4595C42.527 17.8215 42.2452 17.1885 41.9634 16.5402C41.9211 16.4432 41.799 16.4432 41.7568 16.5402C41.1885 17.8266 40.6249 19.0976 40.0566 20.3942C40.0143 20.4861 39.8969 20.4912 39.8499 20.3993C38.3564 17.3314 36.8723 14.2839 35.374 11.216C35.4304 11.216 35.468 11.216 35.5055 11.216C36.2993 11.216 37.0977 11.216 37.8914 11.2109C37.9807 11.2109 38.0229 11.2467 38.0605 11.3283C38.6899 12.7117 39.3239 14.09 39.9579 15.4733C39.9767 15.509 39.9908 15.5448 40.019 15.606C40.1364 15.3406 40.2444 15.0905 40.3478 14.8454C40.4793 14.5494 40.6061 14.2482 40.7376 13.9521C40.7705 13.8807 40.7705 13.8245 40.7376 13.7479C40.39 12.9516 40.0425 12.1502 39.6996 11.3488C39.6855 11.313 39.6668 11.2773 39.6527 11.2365C39.6761 11.2007 39.709 11.216 39.7372 11.216C40.4323 11.216 41.1274 11.216 41.8225 11.2109C41.9024 11.2109 41.9399 11.2416 41.9728 11.3181C42.5881 12.7219 43.208 14.1257 43.828 15.5295C43.8327 15.5397 43.8421 15.5499 43.8609 15.5754C43.9595 15.3304 44.0581 15.1007 44.152 14.8659C44.6264 13.6867 45.1055 12.5075 45.5751 11.3283C45.6127 11.2365 45.655 11.2109 45.7442 11.2109C46.4393 11.216 47.1344 11.2109 47.8295 11.2109C46.5896 14.2788 45.2323 17.3212 43.8655 20.384Z" fill="white"/>
                <path d="M59.6416 13.6148C59.6416 15.8149 59.6416 18.015 59.6463 20.2151C59.6463 20.3376 59.6275 20.3733 59.5054 20.3733C58.7962 20.3682 58.0824 20.3682 57.3732 20.3733C57.2839 20.3733 57.2651 20.3478 57.2651 20.2508C57.2698 15.8302 57.2698 11.4096 57.2651 6.99405C57.2651 6.88175 57.298 6.86133 57.3919 6.86133C58.0964 6.86643 58.8056 6.86643 59.5101 6.86133C59.6228 6.86133 59.6463 6.89196 59.6463 7.01447C59.6369 9.21457 59.6416 11.4147 59.6416 13.6148Z" fill="white"/>
                <path d="M56.11 11.3788C56.11 11.3584 56.1053 11.3329 56.11 11.3125C56.1194 11.241 56.0959 11.2206 56.0255 11.2206C55.3304 11.2206 54.6306 11.2206 53.9355 11.2206C53.8228 11.2206 53.7335 11.3176 53.7335 11.4401C53.7335 11.486 53.7335 11.532 53.7335 11.5779C53.7335 11.68 53.6255 11.7362 53.5504 11.68C53.0478 11.2818 52.4842 11.0725 51.8737 11.0368C50.6244 10.9602 49.5676 11.4707 48.7316 12.4661C47.689 13.7117 47.3414 15.1869 47.6326 16.8306C47.9755 18.7397 49.3938 20.3579 51.2866 20.5621C51.9911 20.6387 52.6674 20.5161 53.292 20.1333C53.3813 20.0771 53.4611 20.0159 53.541 19.9444C53.6161 19.8781 53.7288 19.9342 53.7288 20.0414C53.7288 20.118 53.7288 20.1894 53.7241 20.266C53.7194 20.363 53.7429 20.3885 53.8322 20.3885C54.4991 20.3834 55.166 20.3834 55.8376 20.3885C55.9832 20.3885 56.1053 20.2609 56.1053 20.1027C56.1053 17.1828 56.11 14.2783 56.11 11.3788ZM53.6678 16.7438C53.3719 17.535 52.705 18.0149 51.9112 18.0098C50.6572 17.9893 49.8259 16.8663 49.9621 15.5544C50.0608 14.5743 50.6103 13.8903 51.4228 13.6606C52.5688 13.339 53.6772 14.166 53.8087 15.4472C53.8556 15.8964 53.8228 16.3303 53.6678 16.7438Z" fill="white"/>
                <path d="M20.528 11.3792C20.528 11.3537 20.5233 11.3333 20.528 11.3129C20.5374 11.2414 20.5139 11.221 20.4435 11.221C19.7014 11.221 18.964 11.2261 18.222 11.221C18.1468 11.221 18.1421 11.2567 18.1421 11.318C18.1421 11.4048 18.1421 11.4864 18.1421 11.5783C18.1421 11.6804 18.0388 11.7366 17.959 11.6804C17.4564 11.2874 16.8928 11.0781 16.2823 11.0423C15.0846 10.9658 14.0561 11.4303 13.2388 12.3644C12.013 13.7478 11.6655 15.4221 12.1539 17.2649C12.6799 19.2506 14.3285 20.634 16.1883 20.5676C16.8365 20.5421 17.4376 20.3787 17.9543 19.9346C18.0294 19.8683 18.1421 19.9244 18.1421 20.0316C18.1421 20.1031 18.1421 20.1745 18.1374 20.246C18.1327 20.3481 18.1562 20.3736 18.2549 20.3736C18.964 20.3685 19.6685 20.3685 20.3777 20.3736C20.4951 20.3736 20.5327 20.3481 20.5327 20.2154C20.5233 17.27 20.528 14.3246 20.528 11.3792ZM18.0529 16.8208C17.7147 17.6069 17.123 17.9898 16.3809 18.0153C15.3148 18.0153 14.4834 17.1985 14.3801 16.0959C14.2862 15.1158 14.6619 14.2736 15.404 13.8499C16.5171 13.2067 17.9871 13.7988 18.222 15.4068C18.2877 15.8917 18.2455 16.3716 18.0529 16.8208Z" fill="white"/>
            </svg>
            <span class="amwal-promo-text"><?= __('0% Bank Installments up to 12 months.') ?> <span class="amwal-link"><?= __('Learn more') ?></span></span>
        </div>
    </div>

    <div id="amwal-dialog" style="display: none;">
        <div class="amwal-header">
            <svg width="72" height="29" viewBox="0 0 72 29" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect width="72" height="28.946" rx="6" fill="black"/>
                <path d="M24.1912 11.6545C25.5297 10.5672 27.8358 10.9347 28.8503 12.3232C28.8972 12.3845 28.9818 12.3896 29.0287 12.3334C29.0804 12.2722 29.1274 12.2109 29.179 12.1547C29.7191 11.5626 30.3861 11.241 31.1328 11.0981C31.9219 10.9449 32.7015 10.9909 33.453 11.3125C34.3641 11.7004 34.9794 12.4253 35.3598 13.3901C35.6369 14.0843 35.7684 14.8194 35.7731 15.5698C35.7825 17.1216 35.7778 18.6785 35.7872 20.2303C35.7872 20.3579 35.7543 20.3783 35.6463 20.3783C34.9512 20.3732 34.2561 20.3732 33.5657 20.3783C33.453 20.3783 33.4201 20.3528 33.4201 20.2252C33.4248 18.7551 33.4248 17.2849 33.4248 15.8148C33.4248 15.386 33.359 14.9725 33.1712 14.5897C32.5747 13.3748 31.0859 13.2522 30.3109 14.36C30.015 14.7836 29.8741 15.2686 29.8741 15.7944C29.8741 17.2747 29.8741 18.7551 29.8788 20.2354C29.8788 20.3528 29.8506 20.3783 29.7473 20.3783C29.0381 20.3732 28.3242 20.3732 27.615 20.3783C27.5211 20.3783 27.4976 20.3528 27.4976 20.2507C27.5023 18.7704 27.4976 17.29 27.5023 15.8097C27.5023 15.534 27.4788 15.2584 27.4178 14.9878C27.244 14.263 26.6804 13.7168 25.9994 13.6147C24.9521 13.4564 24.3227 14.314 24.1161 15.0644C24.0409 15.3298 24.0127 15.6004 24.0127 15.8811C24.0127 17.29 24.0127 18.704 24.0174 20.1129C24.0174 20.2609 23.9094 20.3783 23.7732 20.3783C23.1016 20.3732 22.43 20.3732 21.7536 20.3783C21.655 20.3783 21.6362 20.3477 21.6362 20.2507C21.6409 17.2798 21.6409 14.314 21.6362 11.3431C21.6362 11.2512 21.6503 11.2206 21.7443 11.2206C22.4675 11.2257 23.1908 11.2257 23.9141 11.2206C23.9892 11.2206 24.0174 11.2359 24.0127 11.3227C24.008 11.4044 24.008 11.4809 24.008 11.5626C24.008 11.6596 24.1161 11.7157 24.1912 11.6545Z" fill="white"/>
                <path d="M43.8655 20.384C43.8233 20.4759 43.7012 20.4759 43.6589 20.384C43.3724 19.7357 43.0906 19.0976 42.8088 18.4595C42.527 17.8215 42.2452 17.1885 41.9634 16.5402C41.9211 16.4432 41.799 16.4432 41.7568 16.5402C41.1885 17.8266 40.6249 19.0976 40.0566 20.3942C40.0143 20.4861 39.8969 40.4912 39.8499 20.3993C38.3564 17.3314 36.8723 14.2839 35.374 11.216C35.4304 11.216 35.468 11.216 35.5055 11.216C36.2993 11.216 37.0977 11.216 37.8914 11.2109C37.9807 11.2109 38.0229 11.2467 38.0605 11.3283C38.6899 12.7117 39.3239 14.09 39.9579 15.4733C39.9767 15.509 39.9908 15.5448 40.019 15.606C40.1364 15.3406 40.2444 15.0905 40.3478 14.8454C40.4793 14.5494 40.6061 14.2482 40.7376 13.9521C40.7705 13.8807 40.7705 13.8245 40.7376 13.7479C40.39 12.9516 40.0425 12.1502 39.6996 11.3488C39.6855 11.313 39.6668 11.2773 39.6527 11.2365C39.6761 11.2007 39.709 11.216 39.7372 11.216C40.4323 11.216 41.1274 11.216 41.8225 11.2109C41.9024 11.2109 41.9399 11.2416 41.9728 11.3181C42.5881 12.7219 43.208 14.1257 43.828 15.5295C43.8327 15.5397 43.8421 15.5499 43.8609 15.5754C43.9595 15.3304 44.0581 15.1007 44.152 14.8659C44.6264 13.6867 45.1055 12.5075 45.5751 11.3283C45.6127 11.2365 45.655 11.2109 45.7442 11.2109C46.4393 11.216 47.1344 11.2109 47.8295 11.2109C46.5896 14.2788 45.2323 17.3212 43.8655 20.384Z" fill="white"/>
                <path d="M59.6416 13.6148C59.6416 15.8149 59.6416 18.015 59.6463 20.2151C59.6463 20.3376 59.6275 20.3733 59.5054 20.3733C58.7962 20.3682 58.0824 20.3682 57.3732 20.3733C57.2839 20.3733 57.2651 20.3478 57.2651 20.2508C57.2698 15.8302 57.2698 11.4096 57.2651 6.99405C57.2651 6.88175 57.298 6.86133 57.3919 6.86133C58.0964 6.86643 58.8056 6.86643 59.5101 6.86133C59.6228 6.86133 59.6463 6.89196 59.6463 7.01447C59.6369 9.21457 59.6416 11.4147 59.6416 13.6148Z" fill="white"/>
                <path d="M56.11 11.3788C56.11 11.3584 56.1053 11.3329 56.11 11.3125C56.1194 11.241 56.0959 11.2206 56.0255 11.2206C55.3304 11.2206 54.6306 11.2206 53.9355 11.2206C53.8228 11.2206 53.7335 11.3176 53.7335 11.4401C53.7335 11.486 53.7335 11.532 53.7335 11.5779C53.7335 11.68 53.6255 11.7362 53.5504 11.68C53.0478 11.2818 52.4842 11.0725 51.8737 11.0368C50.6244 10.9602 49.5676 11.4707 48.7316 12.4661C47.689 13.7117 47.3414 15.1869 47.6326 16.8306C47.9755 18.7397 49.3938 20.3579 51.2866 20.5621C51.9911 20.6387 52.6674 20.5161 53.292 20.1333C53.3813 20.0771 53.4611 20.0159 53.541 19.9444C53.6161 19.8781 53.7288 19.9342 53.7288 20.0414C53.7288 20.118 53.7288 20.1894 53.7241 20.266C53.7194 20.363 53.7429 20.3885 53.8322 20.3885C54.4991 20.3834 55.166 20.3834 55.8376 20.3885C55.9832 20.3885 56.1053 20.2609 56.1053 20.1027C56.1053 17.1828 56.11 14.2783 56.11 11.3788ZM53.6678 16.7438C53.3719 17.535 52.705 18.0149 51.9112 18.0098C50.6572 17.9893 49.8259 16.8663 49.9621 15.5544C50.0608 14.5743 50.6103 13.8903 51.4228 13.6606C52.5688 13.339 53.6772 14.166 53.8087 15.4472C53.8556 15.8964 53.8228 16.3303 53.6678 16.7438Z" fill="white"/>
                <path d="M20.528 11.3792C20.528 11.3537 20.5233 11.3333 20.528 11.3129C20.5374 11.2414 20.5139 11.221 20.4435 11.221C19.7014 11.221 18.964 11.2261 18.222 11.221C18.1468 11.221 18.1421 11.2567 18.1421 11.318C18.1421 11.4048 18.1421 11.4864 18.1421 11.5783C18.1421 11.6804 18.0388 11.7366 17.959 11.6804C17.4564 11.2874 16.8928 11.0781 16.2823 11.0423C15.0846 10.9658 14.0561 11.4303 13.2388 12.3644C12.013 13.7478 11.6655 15.4221 12.1539 17.2649C12.6799 19.2506 14.3285 20.634 16.1883 20.5676C16.8365 20.5421 17.4376 20.3787 17.9543 19.9346C18.0294 19.8683 18.1421 19.9244 18.1421 20.0316C18.1421 20.1031 18.1421 20.1745 18.1374 20.246C18.1327 20.3481 18.1562 20.3736 18.2549 20.3736C18.964 20.3685 19.6685 20.3685 20.3777 20.3736C20.4951 20.3736 20.5327 20.3481 20.5327 20.2154C20.5233 17.27 20.528 14.3246 20.528 11.3792ZM18.0529 16.8208C17.7147 17.6069 17.123 17.9898 16.3809 18.0153C15.3148 18.0153 14.4834 17.1985 14.3801 16.0959C14.2862 15.1158 14.6619 14.2736 15.404 13.8499C16.5171 13.2067 17.9871 13.7988 18.222 15.4068C18.2877 15.8917 18.2455 16.3716 18.0529 16.8208Z" fill="white"/>
            </svg>
            <div class="amwal-close"></div>
        </div>
        <div class="amwal-body">
            <!-- Iframe will be generated dynamically here -->
        </div>
    </div>
<?php endif; ?>
