<?php
/** @var \Magento\Framework\Escaper $escaper */
/** @var \Amwal\Payments\Block\ExpressCheckoutMinicartButton $block */
/** @var \Amwal\Payments\ViewModel\ExpressCheckoutButton $viewModel */
$viewModel = $block->getViewModel();
$quote = $block->getQuote();
$quoteId = $quote ? $quote->getId() : 'newquote';
$viewModel->setQuoteId((string)$quoteId);
?>
<div id="amwal-cart-button" class="amwal-express-checkout-button">
    <amwal-checkout-button
        merchant-id="<?= $escaper->escapeHtmlAttr($viewModel->getMerchantId()) ?>"
        amount="<?= $escaper->escapeHtmlAttr($quote ? $quote->getSubtotal() : 0) ?>"
        country-code="<?= $escaper->escapeHtmlAttr($viewModel->getCountryCode()) ?>"
        locale="<?= $escaper->escapeHtmlAttr($viewModel->getLocale()) ?>"
        dark-mode="<?= $escaper->escapeHtmlAttr($viewModel->isDarkModeEnabled() ? 'on' : 'off') ?>"
        email-required="<?= $escaper->escapeHtmlAttr($viewModel->isCustomerLoggedIn() ? 'false' : 'true') ?>"
        address-required="true"
        address-handshake="true"
        shipping-methods='[]'
        ref-id="<?= $escaper->escapeHtmlAttr($viewModel->getRefId()) ?>"
        label="quick-buy"
        show-payment-brands="true"
        allowed-address-countries='<?= $escaper->escapeHtmlAttr($viewModel->getAllowedCountriesJson()) ?>'
        enable-pre-checkout-trigger="true"
        enable-pre-pay-trigger="true"
        id="amwal-checkout-cart-<?= $escaper->escapeHtmlAttr($quoteId) ?>"
        <?php if ($limitRegions = $viewModel->getLimitedRegionCodesJson()): ?>
            allowed-address-states='<?= $escaper->escapeHtmlAttr($limitRegions) ?>'
        <?php endif; ?>
        <?php if ($limitCities = $viewModel->getCityCodesJson()): ?>
            allowed-address-cities='<?= $escaper->escapeHtmlAttr($limitCities) ?>'
        <?php endif; ?>
        <?php foreach ($viewModel->getInitialDataAttributes() as $attribute => $value): ?>
            <?= $attribute ?>='<?= $escaper->escapeHtmlAttr($value) ?>'
        <?php endforeach; ?>
        <?php if ($viewModel->getMerchantMode() === \Amwal\Payments\Model\Config\Source\MerchantMode::MERCHANT_TEST_MODE): ?>
            test-environment="qa"
        <?php endif; ?>/>
<script type="text/x-magento-init">
    {
        "#amwal-checkout-cart-<?= $quoteId ?>": {
            "Amwal_Payments/js/checkout-button-cart": {
                "pluginVersion" : "<?= $viewModel->getPluginVersion() ?>",
                "hideProceedToCheckout": <?= (int) $viewModel->shouldHideProceedToCheckout() ?>,
                "quotePrice": "<?= $quote ? $quote->getSubtotal() : 0 ?>",
                "quoteId": "<?= $quoteId ?>",
                "refId": "<?= $viewModel->getRefId() ?>",
                "refIdData": <?= $viewModel->getRefIdData()->toJson() ?>,
                "customerId": "<?= $viewModel->getCustomerId() ?>"
            }
        }
    }
</script>
