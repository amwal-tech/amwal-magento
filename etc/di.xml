<?xml version="1.0"?>
<config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="urn:magento:framework:ObjectManager/etc/config.xsd">
    <!-- Payment Method Facade configuration -->
    <virtualType name="AmwalIframeFacade" type="Magento\Payment\Model\Method\Adapter">
        <arguments>
            <argument name="code" xsi:type="const">Amwal\Payments\Model\Config\Iframe\ConfigProvider::CODE</argument>
            <argument name="formBlockType" xsi:type="string">Amwal\Payments\Block\Iframe\Form</argument>
            <argument name="infoBlockType" xsi:type="string">Amwal\Payments\Block\Iframe\Info</argument>
            <argument name="valueHandlerPool" xsi:type="object">AmwalIframeValueHandlerPool</argument>
            <argument name="validatorPool" xsi:type="object">AmwalIframeValidatorPool</argument>
            <argument name="commandPool" xsi:type="object">AmwalIframeCommandPool</argument>
        </arguments>
    </virtualType>

    <virtualType name="AmwalIframeValueHandlerPool" type="Magento\Payment\Gateway\Config\ValueHandlerPool">
        <arguments>
            <argument name="handlers" xsi:type="array">
                <item name="default" xsi:type="string">AmwalIframeValueHandler</item>
                <item name="can_void" xsi:type="string">Amwal\Payments\Gateway\Config\CanVoidHandler</item>
                <item name="can_refund" xsi:type="string">Amwal\Payments\Gateway\Config\CanRefundHandler</item>
                <!-- 				<item name="can_cancel" xsi:type="string">Amwal\Payments\Gateway\Config\CanCancelHandler</item>-->
            </argument>
        </arguments>
    </virtualType>
    <virtualType name="AmwalIframeValueHandler" type="Magento\Payment\Gateway\Config\ConfigValueHandler">
        <arguments>
            <argument name="configInterface" xsi:type="object">Amwal\Payments\Gateway\Config\Iframe\Config</argument>
        </arguments>
    </virtualType>


    <virtualType name="AmwalIframeCountryValidator" type="Magento\Payment\Gateway\Validator\CountryValidator">
        <arguments>
            <argument name="config" xsi:type="object">Amwal\Payments\Gateway\Config\Iframe\Config</argument>
        </arguments>
    </virtualType>
    <virtualType name="AmwalIframeValidatorPool" type="Magento\Payment\Gateway\Validator\ValidatorPool">
        <arguments>
            <argument name="validators" xsi:type="array">
                <item name="country" xsi:type="string">AmwalIframeCountryValidator</item>
            </argument>
        </arguments>
    </virtualType>

    <!-- Command Pools -->
    <virtualType name="AmwalIframeCommandPool" type="Magento\Payment\Gateway\Command\CommandPool">
        <arguments>
            <argument name="commands" xsi:type="array">
                <item name="authorize" xsi:type="string">AmwalIframeAuthorizeCommand</item>
                <item name="capture" xsi:type="string">AmwalIframeCaptureCommand</item>
                <item name="sale" xsi:type="string">AmwalIframeSaleCommand</item>
                <item name="settle" xsi:type="string">AmwalIframeSettleCommand</item>
                <item name="vault_authorize" xsi:type="string">AmwalIframeVaultAuthorizeCommand</item>
                <item name="vault_sale" xsi:type="string">AmwalIframeVaultSaleCommand</item>
                <item name="refund" xsi:type="string">AmwalIframeRefundCommand</item>
                <item name="void" xsi:type="string">AmwalIframeVoidCommand</item>
                <item name="cancel" xsi:type="string">AmwalIframeVoidCommand</item>
            </argument>
        </arguments>
    </virtualType>

    <!-- Vault Command Managers -->
    <virtualType name="AmwalIframeCommandManager" type="Magento\Payment\Gateway\Command\CommandManager">
        <arguments>
            <argument name="commandPool" xsi:type="object">AmwalIframeCommandPool</argument>
        </arguments>
    </virtualType>

    <type name="Magento\Payment\Gateway\Command\CommandManagerPool">
        <arguments>
            <argument name="executors" xsi:type="array">
                <item name="amwal_payments" xsi:type="string">AmwalIframeCommandManager</item>
            </argument>
        </arguments>
    </type>

    <virtualType name="AmwalIframeAuthorizeCommand" type="Magento\Payment\Gateway\Command\GatewayCommand">
        <arguments>
            <argument name="requestBuilder" xsi:type="object">AmwalIframeAuthorizeRequest</argument>
            <argument name="transferFactory" xsi:type="object">Amwal\Payments\Gateway\Http\Iframe\TransferFactory</argument>
            <argument name="client" xsi:type="object">Amwal\Payments\Gateway\Http\Iframe\Client\TransactionAuth</argument>
            <argument name="handler" xsi:type="object">AmwalIframeAuthorizeHandler</argument>
            <argument name="validator" xsi:type="object">Amwal\Payments\Gateway\Validator\Iframe\TransactionResponseValidator</argument>
            <argument name="errorMessageMapper" xsi:type="object">Amwal\Payments\Gateway\ErrorMapper\Iframe\VirtualErrorMessageMapper</argument>
        </arguments>
    </virtualType>

    <virtualType name="AmwalIframeCaptureCommand" type="Amwal\Payments\Gateway\Command\Iframe\CaptureStrategyCommand">
        <arguments>
            <argument name="commandPool" xsi:type="object">AmwalIframeCommandPool</argument>
        </arguments>
    </virtualType>

    <virtualType name="AmwalIframeSaleCommand" type="AmwalIframeAuthorizeCommand">
        <arguments>
            <argument name="client" xsi:type="object">Amwal\Payments\Gateway\Http\Iframe\Client\TransactionSale</argument>
        </arguments>
    </virtualType>

    <virtualType name="AmwalIframeSettleCommand" type="Magento\Payment\Gateway\Command\GatewayCommand">
        <arguments>
            <argument name="requestBuilder" xsi:type="object">AmwalIframeSettleRequest</argument>
            <argument name="transferFactory" xsi:type="object">Amwal\Payments\Gateway\Http\Iframe\TransferFactory</argument>
            <argument name="client" xsi:type="object">Amwal\Payments\Gateway\Http\Iframe\Client\TransactionCapture</argument>
            <argument name="handler" xsi:type="object">AmwalIframeSettleHandler</argument>
            <argument name="validator" xsi:type="object">Amwal\Payments\Gateway\Validator\Iframe\TransactionResponseValidator</argument>
            <argument name="errorMessageMapper" xsi:type="object">Amwal\Payments\Gateway\ErrorMapper\Iframe\VirtualErrorMessageMapper</argument>
        </arguments>
    </virtualType>

    <virtualType name="AmwalIframeVaultAuthorizeCommand" type="Magento\Payment\Gateway\Command\GatewayCommand">
        <arguments>
            <argument name="requestBuilder" xsi:type="object">AmwalIframeAuthorizeRequest</argument>
            <argument name="transferFactory" xsi:type="object">Amwal\Payments\Gateway\Http\Iframe\TransferFactory</argument>
            <argument name="client" xsi:type="object">Amwal\Payments\Gateway\Http\Iframe\Client\TransactionAuth</argument>
            <argument name="handler" xsi:type="object">AmwalIframeAuthorizeHandler</argument>
            <argument name="validator" xsi:type="object">Amwal\Payments\Gateway\Validator\Iframe\TransactionResponseValidator</argument>
            <argument name="errorMessageMapper" xsi:type="object">Amwal\Payments\Gateway\ErrorMapper\Iframe\VirtualErrorMessageMapper</argument>
        </arguments>
    </virtualType>

    <virtualType name="AmwalIframeVaultSaleCommand" type="AmwalIframeVaultAuthorizeCommand">
        <arguments>
            <argument name="client" xsi:type="object">Amwal\Payments\Gateway\Http\Iframe\Client\TransactionSale</argument>
        </arguments>
    </virtualType>

    <virtualType name="AmwalIframeVoidCommand" type="Magento\Payment\Gateway\Command\GatewayCommand">
        <arguments>
            <argument name="client" xsi:type="object">Amwal\Payments\Gateway\Http\Iframe\Client\TransactionVoid</argument>
            <argument name="requestBuilder" xsi:type="object">AmwalIframeVoidRequestBuilder</argument>
            <argument name="handler" xsi:type="object">Amwal\Payments\Gateway\Response\Iframe\VoidHandler</argument>
            <argument name="validator" xsi:type="object">Amwal\Payments\Gateway\Validator\Iframe\TransactionResponseValidator</argument>
            <argument name="transferFactory" xsi:type="object">Amwal\Payments\Gateway\Http\Iframe\TransferFactory</argument>
        </arguments>
    </virtualType>

    <virtualType name="AmwalIframeRefundCommand" type="Magento\Payment\Gateway\Command\GatewayCommand">
        <arguments>
            <argument name="client" xsi:type="object">Amwal\Payments\Gateway\Http\Iframe\Client\TransactionRefund</argument>
            <argument name="requestBuilder" xsi:type="object">AmwalIframeRefundRequestBuilder</argument>
            <argument name="handler" xsi:type="object">Amwal\Payments\Gateway\Response\Iframe\RefundHandler</argument>
            <argument name="validator" xsi:type="object">Amwal\Payments\Gateway\Validator\Iframe\TransactionResponseValidator</argument>
            <argument name="transferFactory" xsi:type="object">Amwal\Payments\Gateway\Http\Iframe\TransferFactory</argument>
        </arguments>
    </virtualType>

    <!-- Request Builders -->
    <virtualType name="AmwalIframeAuthorizeRequest" type="Magento\Payment\Gateway\Request\BuilderComposite">
        <arguments>
            <argument name="builders" xsi:type="array">
                <item name="payment" xsi:type="string">Amwal\Payments\Gateway\Request\Iframe\PaymentDataBuilder</item>
                <item name="customer" xsi:type="string">Amwal\Payments\Gateway\Request\Iframe\CustomerDataBuilder</item>
                <item name="address" xsi:type="string">Amwal\Payments\Gateway\Request\Iframe\AddressDataBuilder</item>
                <item name="store" xsi:type="string">Amwal\Payments\Gateway\Request\Iframe\StoreConfigBuilder</item>
                <item name="merchant_account" xsi:type="string">Amwal\Payments\Gateway\Request\Iframe\MerchantAccountDataBuilder</item>
                <item name="level_two" xsi:type="string">Amwal\Payments\Gateway\Request\Iframe\LevelTwoDataBuilder</item>
                <item name="level_three" xsi:type="string">Amwal\Payments\Gateway\Request\Iframe\LevelThreeDataBuilder</item>
                <item name="vault" xsi:type="string">Amwal\Payments\Gateway\Request\Iframe\VaultDataBuilder</item>
            </argument>
        </arguments>
    </virtualType>

    <virtualType name="AmwalIframeSettleRequest" type="Magento\Payment\Gateway\Request\BuilderComposite">
        <arguments>
            <argument name="builders" xsi:type="array">
                <item name="payment" xsi:type="string">Amwal\Payments\Gateway\Request\Iframe\CaptureDataBuilder</item>
                <item name="customer" xsi:type="string">Amwal\Payments\Gateway\Request\Iframe\CustomerDataBuilder</item>
                <item name="address" xsi:type="string">Amwal\Payments\Gateway\Request\Iframe\AddressDataBuilder</item>
                <item name="store" xsi:type="string">Amwal\Payments\Gateway\Request\Iframe\StoreConfigBuilder</item>
                <item name="merchant_account" xsi:type="string">Amwal\Payments\Gateway\Request\Iframe\MerchantAccountDataBuilder</item>
                <item name="level_two" xsi:type="string">Amwal\Payments\Gateway\Request\Iframe\LevelTwoDataBuilder</item>
                <item name="level_three" xsi:type="string">Amwal\Payments\Gateway\Request\Iframe\LevelThreeDataBuilder</item>
            </argument>
        </arguments>
    </virtualType>

    <!-- Response Handlers -->
    <virtualType name="AmwalIframeAuthorizeHandler" type="Magento\Payment\Gateway\Response\HandlerChain">
        <arguments>
            <argument name="handlers" xsi:type="array">
                <item name="payment_details" xsi:type="string">Amwal\Payments\Gateway\Response\Iframe\PaymentDetailsHandler</item>
                <item name="txn_id" xsi:type="string">Amwal\Payments\Gateway\Response\Iframe\TransactionIdHandler</item>
                <item name="card_details" xsi:type="string">Amwal\Payments\Gateway\Response\Iframe\CardDetailsHandler</item>
                <item name="vault_details" xsi:type="string">	Amwal\Payments\Gateway\Response\Iframe\VaultDetailsHandler</item>
            </argument>
        </arguments>
    </virtualType>

    <virtualType name="AmwalIframeSettleHandler" type="Magento\Payment\Gateway\Response\HandlerChain">
        <arguments>
            <argument name="handlers" xsi:type="array">
                <item name="payment_details" xsi:type="string">Amwal\Payments\Gateway\Response\Iframe\PaymentDetailsHandler</item>
                <item name="settlement" xsi:type="string">Amwal\Payments\Gateway\Response\Iframe\SettleHandler</item>
                <item name="card_details" xsi:type="string">Amwal\Payments\Gateway\Response\Iframe\CardDetailsHandler</item>
            </argument>
        </arguments>
    </virtualType>

    <virtualType name="AmwalIframeRefundRequestBuilder" type="Magento\Payment\Gateway\Request\BuilderComposite">
        <arguments>
            <argument name="builders" xsi:type="array">
                <item name="void" xsi:type="string">Amwal\Payments\Gateway\Request\Iframe\RefundDataBuilder</item>
                <item name="store" xsi:type="string">Amwal\Payments\Gateway\Request\Iframe\StoreConfigBuilder</item>
                <item name="merchant_account" xsi:type="string">Amwal\Payments\Gateway\Request\Iframe\MerchantAccountDataBuilder</item>
            </argument>
        </arguments>
    </virtualType>

    <virtualType name="AmwalIframeVoidRequestBuilder" type="Magento\Payment\Gateway\Request\BuilderComposite">
        <arguments>
            <argument name="builders" xsi:type="array">
                <item name="void" xsi:type="string">Amwal\Payments\Gateway\Request\Iframe\VoidDataBuilder</item>
                <item name="store" xsi:type="string">Amwal\Payments\Gateway\Request\Iframe\StoreConfigBuilder</item>
                <item name="merchant_account" xsi:type="string">Amwal\Payments\Gateway\Request\Iframe\MerchantAccountDataBuilder</item>
            </argument>
        </arguments>
    </virtualType>

    <!-- Error Mapping  -->
    <virtualType name="Amwal\Payments\Gateway\ErrorMapper\Iframe\VirtualConfigReader" type="Magento\Payment\Gateway\ErrorMapper\VirtualConfigReader">
        <arguments>
            <argument name="fileName" xsi:type="string">iframe-error-mapping.xml</argument>
        </arguments>
    </virtualType>
    <virtualType name="Amwal\Payments\Gateway\ErrorMapper\Iframe\VirtualMappingData" type="Magento\Payment\Gateway\ErrorMapper\MappingData">
        <arguments>
            <argument name="reader" xsi:type="object">Amwal\Payments\Gateway\ErrorMapper\Iframe\VirtualConfigReader</argument>
            <argument name="cacheId" xsi:type="string">iframe_error_mapper</argument>
        </arguments>
    </virtualType>
    <virtualType name="Amwal\Payments\Gateway\ErrorMapper\Iframe\VirtualErrorMessageMapper" type="Magento\Payment\Gateway\ErrorMapper\ErrorMessageMapper">
        <arguments>
            <argument name="messageMapping" xsi:type="object">Amwal\Payments\Gateway\ErrorMapper\Iframe\VirtualMappingData</argument>
        </arguments>
    </virtualType>

    <!-- Config -->
    <type name="Amwal\Payments\Gateway\Config\Config">
        <arguments>
            <argument name="methodCode" xsi:type="const">Amwal\Payments\Model\Config\ConfigProvider::CODE</argument>
        </arguments>
    </type>
    <type name="Amwal\Payments\Gateway\Config\Iframe\Config">
        <arguments>
            <argument name="methodCode" xsi:type="const">Amwal\Payments\Model\Config\Iframe\ConfigProvider::CODE</argument>
        </arguments>
    </type>

    <!-- Payment JS Session Data -->
    <virtualType name="Amwal\Payments\Model\Session\Storage" type="Magento\Framework\Session\Storage">
        <arguments>
            <argument name="namespace" xsi:type="string">amwalpayments</argument>
        </arguments>
    </virtualType>
    <type name="Amwal\Payments\Model\Session">
        <arguments>
            <argument name="storage" xsi:type="object">Amwal\Payments\Model\Session\Storage</argument>
        </arguments>
    </type>

    <!-- Custom Logger for Amwal -->
    <virtualType name="AmwalLoggerHandler" type="Magento\Framework\Logger\Handler\Base">
        <arguments>
            <argument name="filesystem" xsi:type="object">Magento\Framework\Filesystem\Driver\File</argument>
            <argument name="fileName" xsi:type="string">/var/log/amwal-payments.log</argument>
        </arguments>
    </virtualType>
    <virtualType name="AmwalLogger" type="Magento\Framework\Logger\Monolog">
        <arguments>
            <argument name="name" xsi:type="string">Amwal Payments Logger</argument>
            <argument name="handlers" xsi:type="array">
                <item name="system" xsi:type="object">AmwalLoggerHandler</item>
            </argument>
        </arguments>
    </virtualType>

    <type name="Amwal\Payments\Model\Checkout\UpdateShippingMethod">
        <arguments>
            <argument name="logger" xsi:type="object">AmwalLogger</argument>
        </arguments>
    </type>
    <type name="Amwal\Payments\Model\Checkout\GetQuote">
        <arguments>
            <argument name="logger" xsi:type="object">AmwalLogger</argument>
        </arguments>
    </type>
    <type name="Amwal\Payments\Model\Checkout\InvoiceOrder">
        <arguments>
            <argument name="logger" xsi:type="object">AmwalLogger</argument>
        </arguments>
    </type>
    <type name="Amwal\Payments\Model\Checkout\PlaceOrder">
        <arguments>
            <argument name="logger" xsi:type="object">AmwalLogger</argument>
        </arguments>
    </type>
    <type name="Amwal\Payments\Model\AddressResolver">
        <arguments>
            <argument name="logger" xsi:type="object">AmwalLogger</argument>
        </arguments>
    </type>

    <preference for="Amwal\Payments\Api\Data\AmwalOrderItemInterface" type="Amwal\Payments\Model\Data\AmwalOrderItem"/>
    <preference for="Amwal\Payments\Api\Data\AmwalAddressInterface" type="Amwal\Payments\Model\Data\AmwalAddress"/>
    <preference for="Amwal\Payments\Api\RefIdManagementInterface" type="Amwal\Payments\Model\RefIdManagement"/>
    <preference for="Amwal\Payments\Api\Data\RefIdDataInterface" type="Amwal\Payments\Model\Data\RefIdData"/>
</config>
